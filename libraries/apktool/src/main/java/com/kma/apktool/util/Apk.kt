package com.kma.apktool.util

import com.kma.apktool.BuildConfig
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.async
import kotlinx.coroutines.awaitAll
import kotlinx.coroutines.flow.asFlow
import kotlinx.coroutines.flow.map
import kotlinx.coroutines.flow.toList
import kotlinx.coroutines.withContext
import org.jf.baksmali.Baksmali
import org.jf.baksmali.BaksmaliOptions
import org.jf.dexlib2.DexFileFactory
import org.jf.dexlib2.Opcodes
import org.jf.dexlib2.analysis.InlineMethodResolver
import org.jf.dexlib2.dexbacked.DexBackedDexFile
import org.jf.dexlib2.dexbacked.DexBackedOdexFile
import org.jf.dexlib2.iface.MultiDexContainer
import java.io.File
import java.io.FileNotFoundException

private const val MAX_PROCESSOR = 6
private const val MAX_ENTRY_SIZE = 8

suspend fun File.disassemble(outDir: File): Unit = withContext(context = Dispatchers.IO) {
    if (this@disassemble.isFile.not() || this@disassemble.canRead().not()) {
        throw FileNotFoundException("${this@disassemble.name} is not file or can't readable.")
    }

    val opcodes = Opcodes.forApi(0)
    val container = DexFileFactory.loadDexContainer(this@disassemble, opcodes)
    val entries = container
        .dexEntryNames
        .mapNotNull { name -> container.getEntry(name) }

    when {
        entries.size > MAX_ENTRY_SIZE -> entries.asFlow().map { entry -> entry.disassemble(storage = outDir) }

        else -> entries.asFlow()
            .map { entry -> async { entry.disassemble(storage = outDir) } }
            .toList()
            .awaitAll()
    }
}

fun MultiDexContainer.DexEntry<out DexBackedDexFile>.disassemble(storage: File) {
    val name = entryName.substring(startIndex = 0, endIndex = entryName.indexOf("."))
    val folder = File(storage, name)
    val dexFile = dexFile
    val options = BaksmaliOptions().apply {
        deodex = false
        implicitReferences = false
        parameterRegisters = true
        localsDirective = true
        sequentialLabels = true
        debugInfo = BuildConfig.DEBUG
        codeOffsets = false
        accessorComments = false
        registerInfo = 0
        inlineResolver = null
    }

    if (this is DexBackedOdexFile) {
        options.inlineResolver = InlineMethodResolver.createInlineMethodResolver(odexVersion)
    }
    Baksmali.disassembleDexFile(dexFile, folder, MAX_PROCESSOR, options)
}
