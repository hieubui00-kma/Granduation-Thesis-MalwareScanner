package com.kma.apktool.util

import com.kma.apktool.BuildConfig
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.flow.asFlow
import kotlinx.coroutines.flow.map
import kotlinx.coroutines.flow.mapNotNull
import kotlinx.coroutines.flow.toList
import kotlinx.coroutines.joinAll
import kotlinx.coroutines.launch
import kotlinx.coroutines.sync.Semaphore
import kotlinx.coroutines.sync.withPermit
import kotlinx.coroutines.withContext
import org.jf.baksmali.Baksmali
import org.jf.baksmali.BaksmaliOptions
import org.jf.dexlib2.DexFileFactory
import org.jf.dexlib2.Opcodes
import org.jf.dexlib2.analysis.InlineMethodResolver
import org.jf.dexlib2.dexbacked.DexBackedDexFile
import org.jf.dexlib2.dexbacked.DexBackedOdexFile
import org.jf.dexlib2.iface.MultiDexContainer
import java.io.File
import java.io.FileNotFoundException

private const val MAX_PROCESSOR = 4

suspend fun File.disassemble(outDir: File): Unit = withContext(context = Dispatchers.IO) {
    if (this@disassemble.isFile.not() || this@disassemble.canRead().not()) {
        throw FileNotFoundException("${this@disassemble.name} is not file or can't readable.")
    }

    val semaphore = Semaphore(permits = 2)
    val opcodes = Opcodes.forApi(0)
    val container = DexFileFactory.loadDexContainer(this@disassemble, opcodes)

    container.dexEntryNames
        .asFlow()
        .mapNotNull { name -> container.getEntry(name) }
        .map { entry ->
            semaphore.withPermit {
                launch { entry.disassemble(storage = outDir) }
            }
        }
        .toList()
        .joinAll()
}

fun MultiDexContainer.DexEntry<out DexBackedDexFile>.disassemble(storage: File) {
    val name = entryName.substring(startIndex = 0, endIndex = entryName.indexOf("."))
    val folder = File(storage, name)
    val dexFile = dexFile
    val options = BaksmaliOptions().apply {
        localsDirective = true
        sequentialLabels = true
        debugInfo = BuildConfig.DEBUG
        accessorComments = false
    }

    if (this is DexBackedOdexFile) {
        options.inlineResolver = InlineMethodResolver.createInlineMethodResolver(odexVersion)
    }
    Baksmali.disassembleDexFile(dexFile, folder, MAX_PROCESSOR, options)
}
